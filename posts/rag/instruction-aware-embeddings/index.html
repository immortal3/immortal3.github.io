<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Instruction Aware Embeddings | Dip&#39;Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Why Your Retriever is Failing and How Context Can Save It - Instruction Aware Embeddings">
<meta name="author" content="
Author:
Dipkumar Patel">
<link rel="canonical" href="https://dipkumar.dev/posts/rag/instruction-aware-embeddings/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.9a3a9b6cc85cc3f62d3346fcc6d5b9344945ceca05719846bfd9d1f7a39acc84.css" integrity="sha256-mjqbbMhcw/YtM0b8xtW5NElFzsoFcZhGv9nR96OazIQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://dipkumar.dev/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://dipkumar.dev/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://dipkumar.dev/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://dipkumar.dev/apple-touch-icon.png">
<link rel="mask-icon" href="https://dipkumar.dev/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://dipkumar.dev/posts/rag/instruction-aware-embeddings/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="Instruction Aware Embeddings" />
<meta property="og:description" content="Why Your Retriever is Failing and How Context Can Save It - Instruction Aware Embeddings" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dipkumar.dev/posts/rag/instruction-aware-embeddings/" />
<meta property="og:image" content="https://dipkumar.dev/images/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2025-07-08T13:14:36+05:30" />
<meta property="article:modified_time" content="2025-07-08T13:14:36+05:30" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://dipkumar.dev/images/papermod-cover.png" />
<meta name="twitter:title" content="Instruction Aware Embeddings"/>
<meta name="twitter:description" content="Why Your Retriever is Failing and How Context Can Save It - Instruction Aware Embeddings"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://dipkumar.dev/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Instruction Aware Embeddings",
      "item": "https://dipkumar.dev/posts/rag/instruction-aware-embeddings/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Instruction Aware Embeddings",
  "name": "Instruction Aware Embeddings",
  "description": "Why Your Retriever is Failing and How Context Can Save It - Instruction Aware Embeddings",
  "keywords": [
    
  ],
  "articleBody": "Why Your Retriever is Failing and How Context Can Save It Imagine asking ‚ÄúI want to buy apple‚Äù ‚Äì do you mean Apple Inc. stock, the latest iPhone, or simply fruit? Without context, your retriever may serve you the wrong results.\n1. What Is the Problem in Your Retriever \u0026 Embedding? Modern retrievers map queries and documents into high-dimensional vectors (embeddings) and rank by cosine similarity. But when a query is ambiguous, plain embeddings struggle:\nThey collapse multiple meanings of ‚Äúapple‚Äù into one vector. The top results can mix stock guides, product pages, and nutrition articles. You might think this is a hypothetical scenario that rarely occurs in practice. However, here‚Äôs a real-world example from Google Deep Research that illustrates the issue:\nQuery: \"We want to create a simple presentation on MCP server. We want to discuss why it's needed, current limitations, and potential use cases. We also want to highlight its technical challenges. Let's write a concise presentation for this.\" It returned information about ‚ÄúUnisys ClearPath MCP‚Äù rather than the intended ‚ÄúModel Control Protocol (MCP)‚Äù proposed by Anthropic. This real-world misalignment underscores how context-less embeddings can derail retrieval.\n2. Missing Context in Embedding Embeddings encode semantic similarity but lack task or intent signals. Out of the box, they answer the question:\n‚ÄúWhich documents sound most like this query?‚Äù\nThey don‚Äôt know if ‚Äúapple‚Äù refers to finance, technology, or groceries‚Äîso they return a blend of all.\n3. How Does It Work Without Context? Using script‚Äôs results (see gist), here‚Äôs the plain embedding behavior for ‚ÄúI want to buy apple‚Äù with OpenAI and Qwen models:\nüìù Query: 'I want to buy apple' üîç Using plain query (no instruction) ü§ñ OpenAI Model Results: 1. How to Buy Apple Stock (Score: 0.536) 2. Where to Buy Apples (Score: 0.497) 3. iPhone 15 Pro Purchase (Score: 0.455) ü§ñ Qwen Model Results: 1. Where to Buy Apples (Score: 0.604) 2. How to Buy Apple Stock (Score: 0.594) 3. Health Benefits of Apples (Score: 0.501) Both embeddings mix stock, fruit, and product topics. The Qwen model edges out OpenAI by a small margin, but neither is decisively focused.\n4. Introducing Qwen \u0026 Replicating the Same Thing in OpenAI The Qwen3-Embedding-8B model is instruction-aware, trained to accept task descriptions alongside queries. When we add a ‚Äúgrocery shopping‚Äù instruction:\n# Minimal instruction-aware query construction instruction = \"Given a grocery shopping question, retrieve fruit purchase information\" query = \"I want to buy apple\" instructed_query = f\"Instruction: {instruction}\\nQuery: {query}\" Visualizing the Flow:\nUser Query: \"I want to buy apple\" | v [Plain Embedding Model] | v Results: [Stock guides, iPhones, fruit articles] \u003c-- Mixed, ambiguous User Query + Instruction: \"Given a grocery shopping question, retrieve fruit purchase information\\nI want to buy apple\" | v [Instruction-Aware Embedding Model] | v Results: [Fruit purchase guides, grocery info] \u003c-- Focused, relevant Focused Scenario Performance Gains Below is a comparison of similarity scores for the correct document in each use case, showing how instruction-aware embeddings shift the focus within the same model. Note, OpenAI does not support instruction-aware embeddings yet, but we tried to run the same instruction-aware query with OpenAI‚Äôs embedding model. As you can see, it did not work very well and it‚Äôs clear, instruction-aware embeddings need to be supported by the model and it‚Äôs not just a matter of adding a prefix to the query.\nScenario Model Plain Score Instruction Score Œî Score Financial (Stock Purchase) OpenAI 0.536 0.472 ‚àí0.064 Financial (Stock Purchase) Qwen 0.594 0.743 +0.149 Technology (iPhone Purchase) OpenAI 0.455 0.393 ‚àí0.062 Technology (iPhone Purchase) Qwen \u003c0.501 0.512 ‚Üë Grocery (Fruit Purchase) OpenAI 0.497 0.502 +0.005 Grocery (Fruit Purchase) Qwen 0.604 0.680 +0.076 Note: Qwen did not surface the iPhone doc in its top-3 plain results (score \u003c0.501), yet it rises to #2 (0.512) with instruction.\nWhat does this mean?\nNotice how Qwen‚Äôs instruction-aware mode dramatically increases the relevance score for the correct document, while OpenAI‚Äôs model barely changes or even drops. This demonstrates that simply adding instructions to the query only works if the model is trained to use them.\n5. Alternative: Query Rewriting Embeddings also benefit when the query itself carries the necessary context. Instead of relying solely on instruction-aware models, you can rewrite the user‚Äôs query using chat history or domain knowledge to inject focus. For example:\nOriginal Query: ‚ÄúI want to buy apple‚Äù Rewritten Query: ‚ÄúWhere can I buy fresh apples at my local grocery store?‚Äù Such rewrites embed context directly into the text, allowing plain embedding models to retrieve the correct documents (fruit vendors, grocery guides) without specialized instructions. This technique can be automated via:\nA chat interface that remembers previous messages and reformulates queries. A domain-specific rewriter that maps generic queries to more precise, vocabulary-rich versions. By combining query rewriting with embeddings, you get the best of both worlds: minimal model changes and focused retrieval.\n6. What You Can Do About It Facing ambiguous queries? You have four straightforward strategies:\nInstruction-aware embeddings\nUse models like Qwen3-Embedding-8B that accept contextual instructions. Best for: New projects or high-priority use cases. Trade-offs: Requires switching your embedding provider. Query rewriting\nRewrite queries to inject context (e.g., ‚ÄúWhere can I buy fresh organic apples?‚Äù). Best for: Legacy systems or teams using plain embedding models. Trade-offs: Requires building and maintaining rewriting logic. Hybrid approach\nCombine query rewriting for immediate gains with instruction-aware models for future migrations. Best for: Teams seeking a phased adoption strategy. Trade-offs: More complex workflow but balances risk and reward. Ask clarifying questions\nDetect vague or ambiguous queries and prompt the user for more details before retrieving. Best for: Interactive search interfaces and chatbots. Trade-offs: Requires a conversational UI and may add extra steps to user interactions. Choose the strategy that fits your team‚Äôs resources and goals, and start by tackling your most ambiguous queries first.\n7. Closing Thoughts Missing context in embeddings is the core challenge for ambiguous queries. Instruction-aware embeddings (like Qwen3-Embedding-8B) deliver stronger task focus, dramatically improving top-ranked results. You can mimic this in OpenAI by manually adding instructions, but specialized models yield bigger gains. What should you do next?\nAudit your current retrieval system for ambiguous queries. Experiment with instruction-aware models if available. Implement query rewriting where needed to improve retrieval focus. Embrace instruction-aware retrieval to resolve ambiguity and serve exactly what users intend‚Äîevery time.\nReferences:\nQwen3 Embedding model card: Hugging Face Code example and full script: compare.py on GitHub Gist ",
  "wordCount" : "1059",
  "inLanguage": "en",
  "image": "https://dipkumar.dev/images/papermod-cover.png","datePublished": "2025-07-08T13:14:36+05:30",
  "dateModified": "2025-07-08T13:14:36+05:30",
  "author":{
    "@type": "Person",
    "name": "Dipkumar Patel"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://dipkumar.dev/posts/rag/instruction-aware-embeddings/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Dip'Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://dipkumar.dev/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://dipkumar.dev/" accesskey="h" title="Dip&#39;Blog (Alt + H)">Dip&#39;Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://dipkumar.dev/" title="Posts">
                    <span>Posts</span>
                </a>
            </li>
            <li>
                <a href="https://dipkumar.dev/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://dipkumar.dev/tags/" title="tags">
                    <span>tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Instruction Aware Embeddings
    </h1>
    <div class="post-description">
      Why Your Retriever is Failing and How Context Can Save It - Instruction Aware Embeddings
    </div>
    <div class="post-meta"><span title='2025-07-08 13:14:36 +0530 IST'> July 8, 2025</span>&nbsp;|&nbsp;Estimated Reading Time: 5 min&nbsp;|&nbsp;
Author:
Dipkumar Patel&nbsp;|&nbsp;<a href="https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/posts/rag/instruction-aware-embeddings.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#why-your-retriever-is-failing-and-how-context-can-save-it" aria-label="Why Your Retriever is Failing and How Context Can Save It">Why Your Retriever is Failing and How Context Can Save It</a><ul>
                        
                <li>
                    <a href="#1-what-is-the-problem-in-your-retriever--embedding" aria-label="1. What Is the Problem in Your Retriever &amp; Embedding?">1. What Is the Problem in Your Retriever &amp; Embedding?</a></li>
                <li>
                    <a href="#2-missing-context-in-embedding" aria-label="2. Missing Context in Embedding">2. Missing Context in Embedding</a></li>
                <li>
                    <a href="#3-how-does-it-work-without-context" aria-label="3. How Does It Work Without Context?">3. How Does It Work Without Context?</a></li>
                <li>
                    <a href="#4-introducing-qwen--replicating-the-same-thing-in-openai" aria-label="4. Introducing Qwen &amp; Replicating the Same Thing in OpenAI">4. Introducing Qwen &amp; Replicating the Same Thing in OpenAI</a><ul>
                        
                <li>
                    <a href="#focused-scenario-performance-gains" aria-label="Focused Scenario Performance Gains">Focused Scenario Performance Gains</a></li></ul>
                </li>
                <li>
                    <a href="#5-alternative-query-rewriting" aria-label="5. Alternative: Query Rewriting">5. Alternative: Query Rewriting</a></li>
                <li>
                    <a href="#6-what-you-can-do-about-it" aria-label="6. What You Can Do About It">6. What You Can Do About It</a></li>
                <li>
                    <a href="#7-closing-thoughts" aria-label="7. Closing Thoughts">7. Closing Thoughts</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="why-your-retriever-is-failing-and-how-context-can-save-it">Why Your Retriever is Failing and How Context Can Save It<a hidden class="anchor" aria-hidden="true" href="#why-your-retriever-is-failing-and-how-context-can-save-it">#</a></h1>
<p>Imagine asking &ldquo;I want to buy apple&rdquo; ‚Äì do you mean Apple Inc. stock, the latest iPhone, or simply fruit? Without context, your retriever may serve you the wrong results.</p>
<hr>
<h2 id="1-what-is-the-problem-in-your-retriever--embedding">1. What Is the Problem in Your Retriever &amp; Embedding?<a hidden class="anchor" aria-hidden="true" href="#1-what-is-the-problem-in-your-retriever--embedding">#</a></h2>
<p>Modern retrievers map queries and documents into high-dimensional vectors (embeddings) and rank by cosine similarity. But when a query is <strong>ambiguous</strong>, plain embeddings struggle:</p>
<ul>
<li>They collapse multiple meanings of &ldquo;apple&rdquo; into one vector.</li>
<li>The top results can mix stock guides, product pages, and nutrition articles.</li>
</ul>
<p>You might think this is a hypothetical scenario that rarely occurs in practice. However, here&rsquo;s a real-world example from Google Deep Research that illustrates the issue:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Query: &#34;We want to create a simple presentation on MCP server. We want to discuss why it&#39;s needed, current limitations, and potential use cases.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">We also want to highlight its technical challenges.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Let&#39;s write a concise presentation for this.&#34;
</span></span></code></pre></div><p><img loading="lazy" src="/blog_photos/context-gemini.png" alt="image"  />
</p>
<p>It returned information about &ldquo;Unisys ClearPath MCP&rdquo; rather than the intended &ldquo;Model Control Protocol (MCP)&rdquo; proposed by Anthropic. This real-world misalignment underscores how context-less embeddings can derail retrieval.</p>
<hr>
<h2 id="2-missing-context-in-embedding">2. Missing Context in Embedding<a hidden class="anchor" aria-hidden="true" href="#2-missing-context-in-embedding">#</a></h2>
<p>Embeddings encode <strong>semantic similarity</strong> but lack task or intent signals. Out of the box, they answer the question:</p>
<blockquote>
<p>&ldquo;Which documents <em>sound</em> most like this query?&rdquo;</p>
</blockquote>
<p>They don&rsquo;t know if &ldquo;apple&rdquo; refers to finance, technology, or groceries‚Äîso they return a blend of all.</p>
<hr>
<h2 id="3-how-does-it-work-without-context">3. How Does It Work Without Context?<a hidden class="anchor" aria-hidden="true" href="#3-how-does-it-work-without-context">#</a></h2>
<p>Using script&rsquo;s results (see <a href="https://gist.github.com/immortal3/6af71b0f9be87489d13a7e0f2cf68120">gist</a>), here&rsquo;s the <strong>plain embedding</strong> behavior for &ldquo;I want to buy apple&rdquo; with OpenAI and Qwen models:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">üìù Query: &#39;I want to buy apple&#39;
</span></span><span class="line"><span class="cl">üîç Using plain query (no instruction)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ü§ñ OpenAI Model Results:
</span></span><span class="line"><span class="cl">1. How to Buy Apple Stock   (Score: 0.536)
</span></span><span class="line"><span class="cl">2. Where to Buy Apples      (Score: 0.497)
</span></span><span class="line"><span class="cl">3. iPhone 15 Pro Purchase   (Score: 0.455)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ü§ñ Qwen Model Results:
</span></span><span class="line"><span class="cl">1. Where to Buy Apples       (Score: 0.604)
</span></span><span class="line"><span class="cl">2. How to Buy Apple Stock    (Score: 0.594)
</span></span><span class="line"><span class="cl">3. Health Benefits of Apples (Score: 0.501)
</span></span></code></pre></div><p>Both embeddings mix stock, fruit, and product topics. The <strong>Qwen</strong> model edges out OpenAI by a small margin, but neither is decisively focused.</p>
<h2 id="4-introducing-qwen--replicating-the-same-thing-in-openai">4. Introducing Qwen &amp; Replicating the Same Thing in OpenAI<a hidden class="anchor" aria-hidden="true" href="#4-introducing-qwen--replicating-the-same-thing-in-openai">#</a></h2>
<p>The <a href="https://qwenlm.github.io/blog/qwen3-embedding/">Qwen3-Embedding-8B model</a> is <strong>instruction-aware</strong>, trained to accept task descriptions alongside queries. When we add a &ldquo;grocery shopping&rdquo; instruction:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Minimal instruction-aware query construction</span>
</span></span><span class="line"><span class="cl"><span class="n">instruction</span> <span class="o">=</span> <span class="s2">&#34;Given a grocery shopping question, retrieve fruit purchase information&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">query</span> <span class="o">=</span> <span class="s2">&#34;I want to buy apple&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">instructed_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;Instruction: </span><span class="si">{</span><span class="n">instruction</span><span class="si">}</span><span class="se">\n</span><span class="s2">Query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span></code></pre></div><p><img loading="lazy" src="/blog_photos/context-qwen.png" alt="image"  />
</p>
<hr>
<p><strong>Visualizing the Flow:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">User Query: &#34;I want to buy apple&#34;
</span></span><span class="line"><span class="cl">        |
</span></span><span class="line"><span class="cl">        v
</span></span><span class="line"><span class="cl">[Plain Embedding Model]
</span></span><span class="line"><span class="cl">        |
</span></span><span class="line"><span class="cl">        v
</span></span><span class="line"><span class="cl">Results: [Stock guides, iPhones, fruit articles]  &lt;-- Mixed, ambiguous
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">User Query + Instruction: &#34;Given a grocery shopping question, retrieve fruit purchase information\nI want to buy apple&#34;
</span></span><span class="line"><span class="cl">        |
</span></span><span class="line"><span class="cl">        v
</span></span><span class="line"><span class="cl">[Instruction-Aware Embedding Model]
</span></span><span class="line"><span class="cl">        |
</span></span><span class="line"><span class="cl">        v
</span></span><span class="line"><span class="cl">Results: [Fruit purchase guides, grocery info]  &lt;-- Focused, relevant
</span></span></code></pre></div><hr>
<h3 id="focused-scenario-performance-gains">Focused Scenario Performance Gains<a hidden class="anchor" aria-hidden="true" href="#focused-scenario-performance-gains">#</a></h3>
<p>Below is a comparison of similarity scores for the <strong>correct document</strong> in each use case, showing how instruction-aware embeddings shift the focus within the same model.
Note, OpenAI does not support instruction-aware embeddings yet, but we tried to run the same instruction-aware query with OpenAI&rsquo;s embedding model. As you can see, it did not work very well and it&rsquo;s clear, instruction-aware embeddings need to be supported by the model and it&rsquo;s not just a matter of adding a prefix to the query.</p>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>Model</th>
<th>Plain Score</th>
<th>Instruction Score</th>
<th>Œî Score</th>
</tr>
</thead>
<tbody>
<tr>
<td>Financial (Stock Purchase)</td>
<td>OpenAI</td>
<td>0.536</td>
<td>0.472</td>
<td>‚àí0.064</td>
</tr>
<tr>
<td>Financial (Stock Purchase)</td>
<td>Qwen</td>
<td>0.594</td>
<td>0.743</td>
<td>+0.149</td>
</tr>
<tr>
<td>Technology (iPhone Purchase)</td>
<td>OpenAI</td>
<td>0.455</td>
<td>0.393</td>
<td>‚àí0.062</td>
</tr>
<tr>
<td>Technology (iPhone Purchase)</td>
<td>Qwen</td>
<td><em>&lt;0.501</em></td>
<td>0.512</td>
<td><strong>‚Üë</strong></td>
</tr>
<tr>
<td>Grocery (Fruit Purchase)</td>
<td>OpenAI</td>
<td>0.497</td>
<td>0.502</td>
<td>+0.005</td>
</tr>
<tr>
<td>Grocery (Fruit Purchase)</td>
<td>Qwen</td>
<td>0.604</td>
<td>0.680</td>
<td>+0.076</td>
</tr>
</tbody>
</table>
<p><em>Note:</em> Qwen did not surface the iPhone doc in its top-3 plain results (score &lt;0.501), yet it rises to #2 (0.512) with instruction.</p>
<p><strong>What does this mean?</strong><br>
Notice how Qwen&rsquo;s instruction-aware mode dramatically increases the relevance score for the correct document, while OpenAI&rsquo;s model barely changes or even drops. This demonstrates that simply adding instructions to the query only works if the model is trained to use them.</p>
<hr>
<h2 id="5-alternative-query-rewriting">5. Alternative: Query Rewriting<a hidden class="anchor" aria-hidden="true" href="#5-alternative-query-rewriting">#</a></h2>
<p>Embeddings also benefit when the query itself carries the necessary context. Instead of relying solely on instruction-aware models, you can rewrite the user&rsquo;s query using chat history or domain knowledge to inject focus. For example:</p>
<ul>
<li><strong>Original Query:</strong> &ldquo;I want to buy apple&rdquo;</li>
<li><strong>Rewritten Query:</strong> &ldquo;Where can I buy fresh apples at my local grocery store?&rdquo;</li>
</ul>
<p>Such rewrites embed context directly into the text, allowing plain embedding models to retrieve the correct documents (fruit vendors, grocery guides) without specialized instructions. This technique can be automated via:</p>
<ul>
<li>A chat interface that remembers previous messages and reformulates queries.</li>
<li>A domain-specific rewriter that maps generic queries to more precise, vocabulary-rich versions.</li>
</ul>
<p>By combining query rewriting with embeddings, you get the best of both worlds: minimal model changes and focused retrieval.</p>
<hr>
<h2 id="6-what-you-can-do-about-it">6. What You Can Do About It<a hidden class="anchor" aria-hidden="true" href="#6-what-you-can-do-about-it">#</a></h2>
<p>Facing ambiguous queries? You have four straightforward strategies:</p>
<ol>
<li>
<p><strong>Instruction-aware embeddings</strong></p>
<ul>
<li>Use models like Qwen3-Embedding-8B that accept contextual instructions.</li>
<li>Best for: New projects or high-priority use cases.</li>
<li>Trade-offs: Requires switching your embedding provider.</li>
</ul>
</li>
<li>
<p><strong>Query rewriting</strong></p>
<ul>
<li>Rewrite queries to inject context (e.g., &ldquo;Where can I buy fresh organic apples?&rdquo;).</li>
<li>Best for: Legacy systems or teams using plain embedding models.</li>
<li>Trade-offs: Requires building and maintaining rewriting logic.</li>
</ul>
</li>
<li>
<p><strong>Hybrid approach</strong></p>
<ul>
<li>Combine query rewriting for immediate gains with instruction-aware models for future migrations.</li>
<li>Best for: Teams seeking a phased adoption strategy.</li>
<li>Trade-offs: More complex workflow but balances risk and reward.</li>
</ul>
</li>
<li>
<p><strong>Ask clarifying questions</strong></p>
<ul>
<li>Detect vague or ambiguous queries and prompt the user for more details before retrieving.</li>
<li>Best for: Interactive search interfaces and chatbots.</li>
<li>Trade-offs: Requires a conversational UI and may add extra steps to user interactions.</li>
</ul>
</li>
</ol>
<p>Choose the strategy that fits your team&rsquo;s resources and goals, and start by tackling your most ambiguous queries first.</p>
<hr>
<h2 id="7-closing-thoughts">7. Closing Thoughts<a hidden class="anchor" aria-hidden="true" href="#7-closing-thoughts">#</a></h2>
<ul>
<li><strong>Missing context</strong> in embeddings is the core challenge for ambiguous queries.</li>
<li><strong>Instruction-aware embeddings</strong> (like Qwen3-Embedding-8B) deliver <em>stronger</em> task focus, dramatically improving top-ranked results.</li>
<li>You can mimic this in OpenAI by manually adding instructions, but specialized models yield bigger gains.</li>
</ul>
<p><strong>What should you do next?</strong></p>
<ul>
<li>Audit your current retrieval system for ambiguous queries.</li>
<li>Experiment with instruction-aware models if available.</li>
<li>Implement query rewriting where needed to improve retrieval focus.</li>
</ul>
<p>Embrace instruction-aware retrieval to resolve ambiguity and serve exactly what users intend‚Äîevery time.</p>
<hr>
<p><em>References:</em></p>
<ul>
<li>Qwen3 Embedding model card: <a href="https://qwenlm.github.io/blog/qwen3-embedding/">Hugging Face</a></li>
<li>Code example and full script: <a href="https://gist.github.com/immortal3/6af71b0f9be87489d13a7e0f2cf68120">compare.py on GitHub Gist</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://dipkumar.dev/">Dip&#39;Blog</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
